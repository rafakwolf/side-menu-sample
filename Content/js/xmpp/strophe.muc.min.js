var Occupant,RoomConfig,XmppRoom,__bind=function(n,t){return function(){return n.apply(t,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(n){return this._connection=n,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(n,t,i,r,u,f,e){var o,s,c,h=this;return s=this.test_append_nick(n,t),o=$pres({from:this._connection.jid,to:s}).c("x",{xmlns:Strophe.NS.MUC}),e!=null&&(o=o.c("history",e)),f!=null&&o.cnode(Strophe.xmlElement("password",[],f)),(c=this._muc_handler)==null&&(this._muc_handler=this._connection.addHandler(function(t){var f,c,i,e,o,l,s,r,u,a;if((f=t.getAttribute("from"),!f)||(o=f.split("/")[0],!h.rooms[o]))return!0;if(n=h.rooms[o],i={},t.nodeName==="message")i=n._message_handlers;else if(t.nodeName==="presence"&&(r=t.getElementsByTagName("x"),r.length>0))for(u=0,a=r.length;u<a;u++)if(l=r[u],s=l.getAttribute("xmlns"),s&&s.match(Strophe.NS.MUC)){i=n._presence_handlers;break}for(e in i)c=i[e],c(t,n)||delete i[e];return!0})),this.rooms.hasOwnProperty(n)||(this.rooms[n]=new XmppRoom(this,n,t,f),this.roomNames.push(n)),r&&this.rooms[n].addHandler("presence",r),i&&this.rooms[n].addHandler("message",i),u&&this.rooms[n].addHandler("roster",u),this._connection.send(o)},leave:function(n,t,i,r){var f,e,u,o;return f=this.roomNames.indexOf(n),delete this.rooms[n],f>=0&&(this.roomNames.splice(f,1),this.roomNames.length===0&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),o=this.test_append_nick(n,t),u=this._connection.getUniqueId(),e=$pres({type:"unavailable",id:u,from:this._connection.jid,to:o}),r!=null&&e.c("status",r),i!=null&&this._connection.addHandler(i,null,"presence",null,u),this._connection.send(e),u},message:function(n,t,i,r,u){var f,e,o,s;return s=this.test_append_nick(n,t),u=u||(t!=null?"chat":"groupchat"),e=this._connection.getUniqueId(),f=$msg({to:s,from:this._connection.jid,type:u,id:e}).c("body",{xmlns:Strophe.NS.CLIENT}).t(i),f.up(),r!=null&&(f.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).t(r),f.node.childNodes.length===0?(o=f.node.parentNode,f.up().up(),f.node.removeChild(o)):f.up().up()),f.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(f),e},groupchat:function(n,t,i){return this.message(n,null,t,i)},invite:function(n,t,i){var r,u;return u=this._connection.getUniqueId(),r=$msg({from:this._connection.jid,to:n,id:u}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:t}),i!=null&&r.c("reason",i),this._connection.send(r),u},directInvite:function(n,t,i,r){var u,e,f;return f=this._connection.getUniqueId(),u={xmlns:"jabber:x:conference",jid:n},i!=null&&(u.reason=i),r!=null&&(u.password=r),e=$msg({from:this._connection.jid,to:t,id:f}).c("x",u),this._connection.send(e),f},queryOccupants:function(n,t,i){var r,u;return r={xmlns:Strophe.NS.DISCO_ITEMS},u=$iq({from:this._connection.jid,to:n,type:"get"}).c("query",r),this._connection.sendIQ(u,t,i)},configure:function(n,t,i){var r,u;return r=$iq({to:n,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),u=r.tree(),this._connection.sendIQ(u,t,i)},cancelConfigure:function(n){var t,i;return t=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),i=t.tree(),this._connection.sendIQ(i)},saveConfiguration:function(n,t,i,r){var e,u,o,f,s;if(u=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),t instanceof Form)t.type="submit",u.cnode(t.toXML());else for(u.c("x",{xmlns:"jabber:x:data",type:"submit"}),f=0,s=t.length;f<s;f++)e=t[f],u.cnode(e).up();return o=u.tree(),this._connection.sendIQ(o,i,r)},createInstantRoom:function(n,t,i){var r;return r=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(r.tree(),t,i)},setTopic:function(n,t){var i;return i=$msg({to:n,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t),this._connection.send(i.tree())},_modifyPrivilege:function(n,t,i,r,u){var f;return f=$iq({to:n,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(t.node),i!=null&&f.c("reason",i),this._connection.sendIQ(f.tree(),r,u)},modifyRole:function(n,t,i,r,u,f){var e;return e=$build("item",{nick:t,role:i}),this._modifyPrivilege(n,e,r,u,f)},kick:function(n,t,i,r,u){return this.modifyRole(n,t,"none",i,r,u)},voice:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},mute:function(n,t,i,r,u){return this.modifyRole(n,t,"visitor",i,r,u)},op:function(n,t,i,r,u){return this.modifyRole(n,t,"moderator",i,r,u)},deop:function(n,t,i,r,u){return this.modifyRole(n,t,"participant",i,r,u)},modifyAffiliation:function(n,t,i,r,u,f){var e;return e=$build("item",{jid:t,affiliation:i}),this._modifyPrivilege(n,e,r,u,f)},ban:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"outcast",i,r,u)},member:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"member",i,r,u)},revoke:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"none",i,r,u)},owner:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"owner",i,r,u)},admin:function(n,t,i,r,u){return this.modifyAffiliation(n,t,"admin",i,r,u)},changeNick:function(n,t){var i,r;return r=this.test_append_nick(n,t),i=$pres({from:this._connection.jid,to:r,id:this._connection.getUniqueId()}),this._connection.send(i.tree())},setStatus:function(n,t,i,r){var u,f;return f=this.test_append_nick(n,t),u=$pres({from:this._connection.jid,to:f}),i!=null&&u.c("show",i).up(),r!=null&&u.c("status",r),this._connection.send(u.tree())},listRooms:function(n,t,i){var r;return r=$iq({to:n,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(r,t,i)},test_append_nick:function(n,t){return n+(t!=null?"/"+Strophe.escapeNode(t):"")}});XmppRoom=function(){function n(n,t,i,r){this.client=n;this.name=t;this.nick=i;this.password=r;this._roomRosterHandler=__bind(this._roomRosterHandler,this);this._addOccupant=__bind(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;n.muc&&(this.client=n.muc);this.name=Strophe.getBareJidFromJid(t);this.addHandler("presence",this._roomRosterHandler)}return n.prototype.join=function(n,t,i){return this.client.join(this.name,this.nick,n,t,i,this.password)},n.prototype.leave=function(n,t){return this.client.leave(this.name,this.nick,n,t),delete this.client.rooms[this.name]},n.prototype.message=function(n,t,i,r){return this.client.message(this.name,n,t,i,r)},n.prototype.groupchat=function(n,t){return this.client.groupchat(this.name,n,t)},n.prototype.invite=function(n,t){return this.client.invite(this.name,n,t)},n.prototype.directInvite=function(n,t){return this.client.directInvite(this.name,n,t,this.password)},n.prototype.configure=function(n){return this.client.configure(this.name,n)},n.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},n.prototype.saveConfiguration=function(n){return this.client.saveConfiguration(this.name,n)},n.prototype.queryOccupants=function(n,t){return this.client.queryOccupants(this.name,n,t)},n.prototype.setTopic=function(n){return this.client.setTopic(this.name,n)},n.prototype.modifyRole=function(n,t,i,r,u){return this.client.modifyRole(this.name,n,t,i,r,u)},n.prototype.kick=function(n,t,i,r){return this.client.kick(this.name,n,t,i,r)},n.prototype.voice=function(n,t,i,r){return this.client.voice(this.name,n,t,i,r)},n.prototype.mute=function(n,t,i,r){return this.client.mute(this.name,n,t,i,r)},n.prototype.op=function(n,t,i,r){return this.client.op(this.name,n,t,i,r)},n.prototype.deop=function(n,t,i,r){return this.client.deop(this.name,n,t,i,r)},n.prototype.modifyAffiliation=function(n,t,i,r,u){return this.client.modifyAffiliation(this.name,n,t,i,r,u)},n.prototype.ban=function(n,t,i,r){return this.client.ban(this.name,n,t,i,r)},n.prototype.member=function(n,t,i,r){return this.client.member(this.name,n,t,i,r)},n.prototype.revoke=function(n,t,i,r){return this.client.revoke(this.name,n,t,i,r)},n.prototype.owner=function(n,t,i,r){return this.client.owner(this.name,n,t,i,r)},n.prototype.admin=function(n,t,i,r){return this.client.admin(this.name,n,t,i,r)},n.prototype.changeNick=function(n){return this.nick=n,this.client.changeNick(this.name,n)},n.prototype.setStatus=function(n,t){return this.client.setStatus(this.name,this.nick,n,t)},n.prototype.addHandler=function(n,t){var i=this._handler_ids++;switch(n){case"presence":this._presence_handlers[i]=t;break;case"message":this._message_handlers[i]=t;break;case"roster":this._roster_handlers[i]=t;break;default:return this._handler_ids--,null}return i},n.prototype.removeHandler=function(n){return delete this._presence_handlers[n],delete this._message_handlers[n],delete this._roster_handlers[n]},n.prototype._addOccupant=function(n){var t;return t=new Occupant(n,this),this.roster[t.nick]=t,t},n.prototype._roomRosterHandler=function(t){var r,o,f,u,i,e;r=n._parsePresence(t);i=r.nick;u=r.newnick||null;switch(r.type){case"error":return;case"unavailable":u&&(r.nick=u,this.roster[i]&&this.roster[u]&&(this.roster[i].update(this.roster[u]),this.roster[u]=this.roster[i]),this.roster[i]&&!this.roster[u]&&(this.roster[u]=this.roster[i].update(r)));delete this.roster[i];break;default:this.roster[i]?this.roster[i].update(r):this._addOccupant(r)}e=this._roster_handlers;for(f in e)o=e[f],o(this.roster,this)||delete this._roster_handlers[f];return!0},n._parsePresence=function(n){var i,r,u,t,f,e,h,c,l,o,a,s,v,y,p,w;for(t={},i=n.attributes,t.nick=Strophe.getResourceFromJid(i.from.textContent),t.type=((l=i.type)!=null?l.textContent:void 0)||null,t.states=[],o=n.childNodes,f=0,h=o.length;f<h;f++){r=o[f];switch(r.nodeName){case"status":t.status=r.textContent||null;break;case"show":t.show=r.textContent||null;break;case"x":if(i=r.attributes,((a=i.xmlns)!=null?a.textContent:void 0)===Strophe.NS.MUC_USER)for(s=r.childNodes,e=0,c=s.length;e<c;e++){u=s[e];switch(u.nodeName){case"item":i=u.attributes;t.affiliation=((v=i.affiliation)!=null?v.textContent:void 0)||null;t.role=((y=i.role)!=null?y.textContent:void 0)||null;t.jid=((p=i.jid)!=null?p.textContent:void 0)||null;t.newnick=((w=i.nick)!=null?w.textContent:void 0)||null;break;case"status":u.attributes.code&&t.states.push(u.attributes.code.textContent)}}}}return t},n}();RoomConfig=function(){function n(n){this.parse=__bind(this.parse,this);n!=null&&this.parse(n)}return n.prototype.parse=function(n){var o,t,i,r,s,h,u,f,e,l,a,v,c;for(h=n.getElementsByTagName("query")[0].childNodes,this.identities=[],this.features=[],this.x=[],u=0,l=h.length;u<l;u++){i=h[u];t=i.attributes;switch(i.nodeName){case"identity":for(s={},f=0,a=t.length;f<a;f++)o=t[f],s[o.name]=o.textContent;this.identities.push(s);break;case"feature":this.features.push(t["var"].textContent);break;case"x":if(t=i.childNodes[0].attributes,!1)break;for(c=i.childNodes,e=0,v=c.length;e<v;e++)(r=c[e],r.attributes.type)||(t=r.attributes,this.x.push({"var":t["var"].textContent,label:t.label.textContent||"",value:r.firstChild.textContent||""}))}}return{identities:this.identities,features:this.features,x:this.x}},n}();Occupant=function(){function n(n,t){this.room=t;this.update=__bind(this.update,this);this.admin=__bind(this.admin,this);this.owner=__bind(this.owner,this);this.revoke=__bind(this.revoke,this);this.member=__bind(this.member,this);this.ban=__bind(this.ban,this);this.modifyAffiliation=__bind(this.modifyAffiliation,this);this.deop=__bind(this.deop,this);this.op=__bind(this.op,this);this.mute=__bind(this.mute,this);this.voice=__bind(this.voice,this);this.kick=__bind(this.kick,this);this.modifyRole=__bind(this.modifyRole,this);this.update(n)}return n.prototype.modifyRole=function(n,t,i,r){return this.room.modifyRole(this.nick,n,t,i,r)},n.prototype.kick=function(n,t,i){return this.room.kick(this.nick,n,t,i)},n.prototype.voice=function(n,t,i){return this.room.voice(this.nick,n,t,i)},n.prototype.mute=function(n,t,i){return this.room.mute(this.nick,n,t,i)},n.prototype.op=function(n,t,i){return this.room.op(this.nick,n,t,i)},n.prototype.deop=function(n,t,i){return this.room.deop(this.nick,n,t,i)},n.prototype.modifyAffiliation=function(n,t,i,r){return this.room.modifyAffiliation(this.jid,n,t,i,r)},n.prototype.ban=function(n,t,i){return this.room.ban(this.jid,n,t,i)},n.prototype.member=function(n,t,i){return this.room.member(this.jid,n,t,i)},n.prototype.revoke=function(n,t,i){return this.room.revoke(this.jid,n,t,i)},n.prototype.owner=function(n,t,i){return this.room.owner(this.jid,n,t,i)},n.prototype.admin=function(n,t,i){return this.room.admin(this.jid,n,t,i)},n.prototype.update=function(n){return this.nick=n.nick||null,this.affiliation=n.affiliation||null,this.role=n.role||null,this.jid=n.jid||null,this.status=n.status||null,this.show=n.show||null,this},n}();