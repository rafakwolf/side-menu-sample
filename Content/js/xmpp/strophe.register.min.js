Strophe.addConnectionPlugin("register",{_connection:null,init:function(n){var i,t,u,r,f;this._connection=n;i=0;Object.keys(Strophe.Status).forEach(function(n){i=Math.max(i,Strophe.Status[n])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGIFAIL=i+1;Strophe.Status.REGISTER=i+2;Strophe.Status.REGISTERED=i+3;Strophe.Status.CONFLICT=i+4;Strophe.Status.NOTACCEPTABLE=i+5;n.disco&&(n.disco.addFeature&&n.disco.addFeature(Strophe.NS.REGISTER),n.disco.addNode&&n.disco.addNode(Strophe.NS.REGISTER,{items:[]}));t=this;u=n.reset.bind(n);n.reset=function(){u();t.instructions="";t.fields={};t.registered=!1};r=n._connect_cb.bind(n);n._connect_cb=function(i,u,f){var e,o;t._registering?(t._connect_cb_data={req:i,raw:f},t._register_cb(i,u,f)&&(t.processed_features=!0,delete t._registering)):t.processed_features?(e=n.xmlInput,n.xmlInput=Strophe.Connection.prototype.xmlInput,o=n.rawInput,n.rawInput=Strophe.Connection.prototype.rawInput,r(i,u,f),n.xmlInput=e,n.rawInput=o,delete t.processed_features):r(i,u,f)};f=n.authenticate.bind(n);n.authenticate=function(n){var t,i;if(typeof n=="undefined"){if(t=this._connection,!this.fields.username||!this.domain||!this.fields.password){Strophe.info("Register a JID first!");return}i=this.fields.username+"@"+this.domain;t.jid=i;t.authzid=Strophe.getBareJidFromJid(t.jid);t.authcid=Strophe.getNodeFromJid(t.jid);t.pass=this.fields.password;var r=this._connect_cb_data.req,u=t.connect_callback,e=this._connect_cb_data.raw;t._connect_cb(r,u,e)}else f(n)}.bind(this)},connect:function(n,t,i,r,u){var f=this._connection;this.domain=Strophe.getDomainFromJid(n);this.instructions="";this.fields={};this.registered=!1;this._registering=!0;f.connect(this.domain,"",t,i,r,u)},_register_cb:function(n,t,i){var r=this._connection,u,e,f,o;if(Strophe.info("_register_cb was called"),r.connected=!0,u=r._proto._reqToData(n),u)return(r.xmlInput!==Strophe.Connection.prototype.xmlInput&&(u.nodeName===r._proto.strip&&u.childNodes.length?r.xmlInput(u.childNodes[0]):r.xmlInput(u)),r.rawInput!==Strophe.Connection.prototype.rawInput&&(i?r.rawInput(i):r.rawInput(Strophe.serialize(u))),e=r._proto._connect_cb(u),e===Strophe.Status.CONNFAIL)?!1:(f=u.getElementsByTagName("register"),o=u.getElementsByTagName("mechanism"),f.length===0&&o.length===0)?(r._proto._no_auth_received(t),!1):f.length===0?(r._changeConnectStatus(Strophe.Status.REGIFAIL,null),!0):(r._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null),r.sendIQ($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree()),!0)},_get_register_cb:function(n){var r,t,i,u=this._connection;if(t=n.getElementsByTagName("query"),t.length!==1)return u._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;for(t=t[0],r=0;r<t.childNodes.length;r++){if(i=t.childNodes[r],i.tagName.toLowerCase()==="instructions"){u.register.instructions=Strophe.getText(i);continue}else if(i.tagName.toLowerCase()==="x")continue;u.register.fields[i.tagName.toLowerCase()]=Strophe.getText(i)}return u._changeConnectStatus(Strophe.Status.REGISTER,null),!1},submit:function(){var n,t,i,r,u=this._connection;for(i=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER}),r=Object.keys(this.fields),n=0;n<r.length;n++)t=r[n],i.c(t).t(this.fields[t]).up();u._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);u.sendIQ(i)},_submit_cb:function(n){var f,i,r,t=null,u=this._connection;if(i=n.getElementsByTagName("query"),i.length>0)for(i=i[0],f=0;f<i.childNodes.length;f++){if(r=i.childNodes[f],r.tagName.toLowerCase()==="instructions"){this.instructions=Strophe.getText(r);continue}this.fields[r.tagName.toLowerCase()]=Strophe.getText(r)}if(n.getAttribute("type")==="error"){if(t=n.getElementsByTagName("error"),t.length!==1)return u._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;Strophe.info("Registration failed.");t=t[0].firstChild.tagName.toLowerCase();t==="conflict"?u._changeConnectStatus(Strophe.Status.CONFLICT,t):t==="not-acceptable"?u._changeConnectStatus(Strophe.Status.NOTACCEPTABLE,t):u._changeConnectStatus(Strophe.Status.REGIFAIL,t)}else Strophe.info("Registration successful."),u._changeConnectStatus(Strophe.Status.REGISTERED,null);return!1}});